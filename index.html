<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Little Math Adventures - Pre-K (Ages 3-5)</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Comic Sans MS', 'Chalkboard SE', 'Segoe UI', Arial, sans-serif;background:linear-gradient(135deg,#FFB6C1 0%,,#87CEEB 50%,,#FFD700 100%);min-height:100vh;padding:16px}
.wrap{max-width:720px;margin:0 auto}

/* Top Bar - Super Simple */
.topbar{background:rgba(255,255,255,0.3);backdrop-filter:blur(10px);border:3px solid white;border-radius:30px;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:14px;position:sticky;top:8px;z-index:100}
.topbar-title{font-size:1.3rem;font-weight:900;color:#fff;text-shadow:2px 2px 0 #FF69B4}
.topbar-btns{display:flex;gap:8px}
.tb-btn{padding:8px 16px;border:none;border-radius:30px;font-weight:800;font-size:0.9rem;cursor:pointer;transition:transform 0.1s;border:2px solid white}
.tb-btn:hover{transform:scale(1.1)}
.tb-save{background:#FFD700;color:#8B4513}
.tb-load{background:#98FB98;color:#006400}
.tb-lbl{font-size:0.8rem;color:#fff;background:rgba(0,0,0,0.2);padding:4px 12px;border-radius:20px}

/* Screens */
.screen{display:none}
.screen.active{display:block}

/* Home Screen - Big & Colorful */
.home-hero{text-align:center;padding:10px 0 14px}
.home-hero h1{font-size:2.5rem;font-weight:900;color:#fff;text-shadow:3px 3px 0 #FF1493, 5px 5px 0 #FFD700;margin-bottom:5px}
.home-hero p{color:white;font-size:1.2rem;background:rgba(0,0,0,0.1);padding:8px 20px;border-radius:30px;display:inline-block}

.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-top:14px}
.menu-card{background:white;border-radius:30px;padding:22px 16px;text-align:center;cursor:pointer;box-shadow:0 8px 0 rgba(0,0,0,0.1),0 12px 24px rgba(0,0,0,0.2);transition:all 0.1s;border:4px solid transparent}
.menu-card:hover{transform:translateY(-5px);box-shadow:0 13px 0 rgba(0,0,0,0.1),0 17px 24px rgba(0,0,0,0.2)}
.menu-card.counting{border-color:#FF6B6B}
.menu-card.numbers{border-color:#4ECDC4}
.menu-card.shapes{border-color:#FFD93D}
.menu-card.patterns{border-color:#96CEB4}
.mc-icon{font-size:3rem;margin-bottom:10px}
.mc-name{font-weight:900;font-size:1.3rem;color:#2D3561;margin-bottom:6px}
.mc-desc{font-size:0.9rem;color:#666;line-height:1.4}
.mc-badge{display:inline-block;margin-top:10px;background:#FF69B4;color:#fff;border-radius:30px;padding:5px 15px;font-size:0.9rem;font-weight:800}

/* Progress Chart - Kid Friendly */
.progress-chart{background:rgba(255,255,255,0.9);border-radius:30px;padding:15px;margin-top:15px;text-align:left;border:4px solid white}
.progress-chart h3{color:#FF1493;font-size:1.2rem;margin-bottom:10px}
.progress-bar-cont{background:#e0e0e0;border-radius:20px;height:25px;margin:8px 0;border:2px solid white}
.progress-bar-fill{height:100%;border-radius:20px;background:linear-gradient(90deg,#FFD700,#FF69B4);width:0%}
.progress-stats{display:flex;justify-content:space-around;margin-top:8px;font-size:1rem;color:#2D3561;font-weight:800}
.progress-stats span{background:white;padding:5px 10px;border-radius:20px;box-shadow:0 2px 0 #ccc}

/* Levels Screen */
.levels-wrap{background:rgba(255,255,255,0.95);border-radius:40px;padding:20px;box-shadow:0 8px 0 rgba(0,0,0,0.1);margin-top:12px;border:4px solid white}
.levels-title{font-size:1.8rem;font-weight:900;color:#FF1493;margin-bottom:16px;text-align:center;text-shadow:2px 2px 0 #FFD700}
.levels-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.lv-btn{background:linear-gradient(135deg,#87CEEB,#4169E1);color:#fff;border:none;border-radius:30px;padding:15px 5px;cursor:pointer;text-align:center;font-weight:800;font-size:1rem;transition:all 0.1s;position:relative;border:3px solid white;box-shadow:0 5px 0 #0000AA}
.lv-btn:hover:not(.locked){transform:translateY(-3px);box-shadow:0 8px 0 #0000AA}
.lv-btn.locked{background:#d3d3d3;color:#888;box-shadow:0 5px 0 #aaa;border-color:#ccc;cursor:not-allowed}
.lv-btn.done{background:linear-gradient(135deg,#FFD700,#FFA500);box-shadow:0 5px 0 #B8860B}
.lv-icon{font-size:2rem;display:block;margin-bottom:4px}
.lv-score{font-size:0.8rem;background:rgba(255,255,255,0.3);border-radius:20px;padding:2px 5px;margin-top:3px}
.lv-lock{position:absolute;top:8px;right:8px;font-size:1.2rem}

/* Quiz Screen - Extra Cute */
.quiz-head{background:white;border-radius:40px;padding:14px 16px;margin-bottom:12px;box-shadow:0 5px 0 #FFB6C1;border:3px solid #FF69B4}
.quiz-meta{display:flex;justify-content:space-between;font-size:1rem;color:#FF1493;font-weight:800;margin-bottom:8px}
.quiz-score-row{display:flex;gap:14px;background:#FFF0F5;border-radius:30px;padding:10px}
.qs-item{text-align:center;flex:1}
.qs-label{font-size:0.8rem;color:#FF69B4}
.qs-val{font-size:2rem;font-weight:900;color:#2D3561}
.prog-bar{background:#e0e0e0;border-radius:20px;height:15px;margin-top:8px;border:2px solid white}
.prog-fill{height:100%;border-radius:20px;background:linear-gradient(90deg,#FFD700,#FF69B4);transition:width 0.4s}

/* Question Card - Super Friendly */
.q-card{background:white;border-radius:40px;padding:22px;box-shadow:0 8px 0 #FFB6C1;margin-bottom:12px;border:4px solid #FF69B4;position:relative}
.q-type-badge{display:inline-block;background:#FF69B4;color:#fff;border-radius:30px;padding:5px 15px;font-size:1rem;font-weight:800;margin-bottom:15px;border:2px solid white}

.q-text{font-size:1.5rem;font-weight:800;color:#2D3561;line-height:1.4;margin-bottom:20px;text-align:center}

/* Number Display */
.big-number{font-size:5rem;font-weight:900;color:#FF1493;text-align:center;margin:15px 0;text-shadow:3px 3px 0 #FFD700}
.number-row{display:flex;justify-content:center;align-items:center;gap:20px;margin:20px 0}
.number-box{width:80px;height:80px;background:#87CEEB;border-radius:30px;display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:900;color:white;border:4px solid white;box-shadow:0 5px 0 #4169E1}
.plus-sign{font-size:3rem;font-weight:900;color:#FF69B4;text-shadow:2px 2px 0 #FFD700}
.equals{font-size:3rem;font-weight:900;color:#FF69B4;text-shadow:2px 2px 0 #FFD700}

/* Counting Objects */
.object-row{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin:20px 0}
.count-object{font-size:2.5rem;transition:all 0.2s;cursor:pointer}
.count-object:hover{transform:scale(1.2)}
.object-label{font-size:1.5rem;color:#2D3561;margin:0 10px}

/* Shape Display */
.shape-display{display:flex;justify-content:center;gap:20px;margin:20px 0}
.circle{width:80px;height:80px;background:#FF6B6B;border-radius:50%;border:4px solid white;box-shadow:0 5px 0 #8B0000}
.square{width:80px;height:80px;background:#4ECDC4;border:4px solid white;box-shadow:0 5px 0 #2E8B57}
.triangle{width:0;height:0;border-left:40px solid transparent;border-right:40px solid transparent;border-bottom:80px solid #FFD93D;filter:drop-shadow(0 5px 0 #B8860B)}
.star{font-size:4rem;color:#FFD700;text-shadow:0 5px 0 #B8860B}

/* Pattern Display */
.pattern-row{display:flex;justify-content:center;gap:15px;margin:20px 0}
.pattern-item{font-size:2.5rem;transition:all 0.2s}
.pattern-item.missing{opacity:0.5;border:3px dashed #FF69B4;border-radius:20px;padding:5px}

/* Big Answer Button */
.big-answer-buttons{display:flex;flex-wrap:wrap;justify-content:center;gap:15px;margin:20px 0}
.answer-btn{width:90px;height:90px;border:none;border-radius:30px;background:#87CEEB;color:#fff;font-size:2.5rem;font-weight:900;cursor:pointer;border:4px solid white;box-shadow:0 5px 0 #4169E1;transition:all 0.1s}
.answer-btn:hover{transform:scale(1.1);background:#98FB98;box-shadow:0 5px 0 #2E8B57}
.answer-btn:active{transform:translateY(5px);box-shadow:0 0 0 #4169E1}
.answer-btn.correct{background:#98FB98;box-shadow:0 5px 0 #2E8B57}
.answer-btn.wrong{background:#FFB6C1;box-shadow:0 5px 0 #8B0000}

/* Touch-friendly Options */
.options{display:grid;gap:12px;margin-top:10px}
.options.two-col{grid-template-columns:1fr 1fr}
.opt-btn{background:#87CEEB;border:none;border-radius:30px;padding:18px 16px;font-size:1.5rem;font-weight:800;color:#fff;cursor:pointer;text-align:center;border:4px solid white;box-shadow:0 5px 0 #4169E1;transition:all 0.1s}
.opt-btn:hover{transform:scale(1.05);background:#98FB98;box-shadow:0 5px 0 #2E8B57}
.opt-btn:active{transform:translateY(5px);box-shadow:0 0 0 #4169E1}
.opt-btn.correct{background:#98FB98;box-shadow:0 5px 0 #2E8B57}
.opt-btn.wrong{background:#FFB6C1;box-shadow:0 5px 0 #8B0000}

/* Feedback */
.feedback{border-radius:30px;padding:20px;font-weight:800;font-size:1.5rem;margin:10px 0;display:none;text-align:center;border:4px solid white}
.feedback.show{display:block}
.feedback.ok{background:#98FB98;color:#006400}
.feedback.bad{background:#FFB6C1;color:#8B0000}

.explanation{background:#FFF9C4;border-radius:30px;padding:15px;font-size:1.1rem;color:#8B4513;font-weight:700;margin:8px 0;display:none;border:3px dashed #FFD700}
.explanation.show{display:block}

.hint-box{background:#E6E6FA;border-radius:30px;padding:15px;font-size:1.2rem;color:#4B0082;font-weight:700;margin:8px 0;display:none;border:3px solid #FFD700}
.hint-box.show{display:block}

/* Buttons - Big & Chunky */
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.btn{padding:15px 20px;border:none;border-radius:40px;font-weight:900;font-size:1.2rem;cursor:pointer;transition:all 0.1s;border:4px solid white;box-shadow:0 5px 0 rgba(0,0,0,0.2)}
.btn:hover{transform:translateY(-3px);box-shadow:0 8px 0 rgba(0,0,0,0.2)}
.btn:active{transform:translateY(5px);box-shadow:0 0 0 rgba(0,0,0,0.2)}
.btn-check{background:#FF69B4;color:#fff;flex:1;box-shadow:0 5px 0 #8B008B}
.btn-next{background:#4ECDC4;color:#fff;flex:1;display:none;box-shadow:0 5px 0 #2E8B57}
.btn-hint{background:#FFD700;color:#8B4513;box-shadow:0 5px 0 #B8860B}
.btn-back{background:#D3D3D3;color:#555;box-shadow:0 5px 0 #808080}

/* Result Screen - Celebration! */
.result-card{background:white;border-radius:50px;padding:28px;text-align:center;box-shadow:0 8px 0 #FFB6C1;margin-top:12px;border:5px solid #FF69B4}
.result-emoji{font-size:5rem;margin-bottom:10px}
.result-title{font-size:2.5rem;font-weight:900;color:#FF1493;margin-bottom:8px;text-shadow:2px 2px 0 #FFD700}
.result-pct{font-size:3rem;font-weight:900;margin:8px 0;color:#4ECDC4}
.result-stars{font-size:3rem;margin:8px 0;color:#FFD700}
.result-msg{background:#FFF0F5;border-radius:30px;padding:15px;font-size:1.2rem;color:#2D3561;font-weight:700;margin:12px 0}
.mistake-section{text-align:left;margin:12px 0;background:#FFF9E6;border-radius:30px;padding:15px}
.mistake-title{font-weight:900;color:#FF69B4;margin-bottom:8px;font-size:1.2rem}
.mistake-item{background:white;border-radius:20px;padding:10px;margin-bottom:8px;font-size:1rem;border:2px solid #FFB6C1}

/* Celebration Animation */
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}
.bounce { animation: bounce 1s infinite; }

@media(max-width:480px){
  .two-col{grid-template-columns:1fr}
  .home-hero h1{font-size:1.8rem}
  .menu-grid{grid-template-columns:repeat(2,1fr)}
  .big-number{font-size:3rem}
  .number-box{width:60px;height:60px;font-size:2rem}
}
</style>
</head>
<body>
<div class="wrap">

<!-- Top Bar - Super Simple -->
<div class="topbar">
  <div class="topbar-title">ğŸ§¸ Little Math</div>
  <div class="topbar-btns">
    <button class="tb-btn tb-save" onclick="saveProgress()">ğŸ’¾ Save</button>
    <button class="tb-btn tb-load" onclick="loadProgress()">ğŸ“‚ Load</button>
    <input type="file" id="loadFile" accept=".json" style="display:none" onchange="loadFile(event)">
  </div>
  <div class="tb-lbl" id="saveLbl">â­ 0 stars</div>
</div>

<!-- HOME SCREEN - Super Friendly -->
<div class="screen active" id="homeScreen">
  <div class="home-hero">
    <h1>ğŸ§¸ Little Math</h1>
    <p>Let's learn and play! â­</p>
  </div>
  <div class="menu-grid">
    <div class="menu-card counting" onclick="openCategory('counting')">
      <div class="mc-icon">ğŸ”¢</div>
      <div class="mc-name">Counting</div>
      <div class="mc-desc">Count apples, stars, and more!</div>
      <div class="mc-badge">5 Levels</div>
    </div>
    <div class="menu-card numbers" onclick="openCategory('numbers')">
      <div class="mc-icon">123</div>
      <div class="mc-name">Numbers</div>
      <div class="mc-desc">Learn numbers 1-10</div>
      <div class="mc-badge">5 Levels</div>
    </div>
    <div class="menu-card shapes" onclick="openCategory('shapes')">
      <div class="mc-icon">ğŸ”´</div>
      <div class="mc-name">Shapes</div>
      <div class="mc-desc">Circle, square, triangle, star!</div>
      <div class="mc-badge">5 Levels</div>
    </div>
    <div class="menu-card patterns" onclick="openCategory('patterns')">
      <div class="mc-icon">ğŸ¨</div>
      <div class="mc-name">Patterns</div>
      <div class="mc-desc">What comes next?</div>
      <div class="mc-badge">5 Levels</div>
    </div>
  </div>
  <div class="progress-chart" id="progressChart"></div>
</div>

<!-- LEVELS SCREEN -->
<div class="screen" id="levelsScreen">
  <div class="levels-wrap">
    <div class="levels-title" id="levelsTitle">Choose a Level</div>
    <div class="levels-grid" id="levelsGrid"></div>
    <div style="margin-top:14px;text-align:center">
      <button class="btn btn-back" onclick="showHome()">â† Back</button>
    </div>
  </div>
</div>

<!-- QUIZ SCREEN -->
<div class="screen" id="quizScreen">
  <div class="quiz-head">
    <div class="quiz-meta">
      <span id="quizLabel">Counting â€¢ Level 1</span>
      <span id="quizQNum">Game 1 / 5</span>
    </div>
    <div class="quiz-score-row">
      <div class="qs-item"><div class="qs-label">Stars</div><div class="qs-val" id="qsCorrect">0</div></div>
      <div class="qs-item"><div class="qs-label">Oops</div><div class="qs-val" id="qsWrong">0</div></div>
      <div class="qs-item"><div class="qs-label">Good!</div><div class="qs-val" id="qsAcc">â­</div></div>
    </div>
    <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
  </div>
  <div class="q-card" id="qCard"></div>
  <div class="hint-box" id="hintBox"></div>
  <div class="feedback" id="feedback"></div>
  <div class="explanation" id="explanation"></div>
  <div class="btn-row">
    <button class="btn btn-back" onclick="leaveQuiz()">â† Home</button>
    <button class="btn btn-hint" id="hintBtn" onclick="showHint()">ğŸ’¡ Hint</button>
    <button class="btn btn-check" id="checkBtn" onclick="checkAnswer()">âœ… Check</button>
    <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">â–¶ Next</button>
  </div>
</div>

<!-- RESULT SCREEN - Celebration Time! -->
<div class="screen" id="resultScreen">
  <div class="result-card">
    <div class="result-emoji" id="resEmoji">ğŸ†</div>
    <div class="result-title" id="resTitle">Great Job!</div>
    <div class="result-pct" id="resPct">â­â­â­</div>
    <div class="result-stars" id="resStars"></div>
    <div class="result-msg" id="resMsg">You're a math superstar! â­</div>
    <div class="mistake-section" id="mistakeSection"></div>
    <div class="btn-row" style="justify-content:center;margin-top:16px">
      <button class="btn btn-back" id="retryBtn">ğŸ” Play Again</button>
      <button class="btn btn-check" onclick="showHome()">ğŸ  Home</button>
      <button class="btn btn-next" id="nextLvBtn" style="display:none">â¡ Next Level</button>
    </div>
  </div>
</div>

</div>

<script>
// ============================================================
// PRE-K MATH - Simple & Fun for 4-Year-Olds!
// ============================================================

function rnd(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ========== COUNTING GENERATOR ==========
function generateCountingQuestions(level) {
  const emojis = ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¹", "ğŸ°", "ğŸ¦Š", "ğŸ»", "ğŸ¼", "ğŸ¨", "ğŸ¸", "ğŸ™", "ğŸ¦„", "â­", "ğŸ", "ğŸª"];
  
  const counts = {
    1: [1, 2, 3], // Level 1: Count 1-3
    2: [1, 2, 3, 4], // Level 2: Count 1-4
    3: [2, 3, 4, 5], // Level 3: Count 2-5
    4: [3, 4, 5, 6], // Level 4: Count 3-6
    5: [4, 5, 6, 7]  // Level 5: Count 4-7
  };
  
  let numbers = counts[level] || counts[1];
  let questions = [];
  
  for(let i = 0; i < 5; i++) {
    let num = numbers[Math.floor(Math.random() * numbers.length)];
    let emoji = emojis[Math.floor(Math.random() * emojis.length)];
    
    questions.push({
      type: 'counting',
      question: `How many ${emoji} do you see?`,
      count: num,
      emoji: emoji,
      objects: Array(num).fill(emoji),
      answer: num,
      hint: `Count them with your finger! 1, 2, 3...`
    });
  }
  
  return questions;
}

// ========== NUMBER RECOGNITION ==========
function generateNumberQuestions(level) {
  const numbers = {
    1: [1, 2, 3],
    2: [1, 2, 3, 4],
    3: [2, 3, 4, 5],
    4: [3, 4, 5, 6],
    5: [4, 5, 6, 7]
  };
  
  let nums = numbers[level] || numbers[1];
  let questions = [];
  
  for(let i = 0; i < 5; i++) {
    let num = nums[Math.floor(Math.random() * nums.length)];
    let wrong1 = num + 1 > 7 ? num - 1 : num + 1;
    let wrong2 = num + 2 > 7 ? num - 2 : num + 2;
    
    questions.push({
      type: 'number',
      question: `Which number is this?`,
      number: num,
      display: 'ğŸ”¢',
      options: shuffle([num, wrong1, wrong2]),
      answer: num,
      hint: `It looks like a ${num}!`
    });
  }
  
  return questions;
}

// ========== SHAPES ==========
function generateShapeQuestions(level) {
  const shapes = {
    1: [
      {name: "circle", emoji: "ğŸ”´", hint: "Round like a ball!"},
      {name: "square", emoji: "ğŸŸ¨", hint: "Four equal sides!"}
    ],
    2: [
      {name: "circle", emoji: "ğŸ”´", hint: "Round like a ball!"},
      {name: "square", emoji: "ğŸŸ¨", hint: "Four equal sides!"},
      {name: "triangle", emoji: "ğŸ”º", hint: "Three sides!"}
    ],
    3: [
      {name: "circle", emoji: "ğŸ”´", hint: "Round like a ball!"},
      {name: "square", emoji: "ğŸŸ¨", hint: "Four equal sides!"},
      {name: "triangle", emoji: "ğŸ”º", hint: "Three sides!"},
      {name: "star", emoji: "â­", hint: "Shiny in the sky!"}
    ],
    4: [
      {name: "circle", emoji: "ğŸ”´", hint: "Round like a ball!"},
      {name: "square", emoji: "ğŸŸ¨", hint: "Four equal sides!"},
      {name: "triangle", emoji: "ğŸ”º", hint: "Three sides!"},
      {name: "star", emoji: "â­", hint: "Shiny in the sky!"},
      {name: "heart", emoji: "â¤ï¸", hint: "Love shape!"}
    ],
    5: [
      {name: "circle", emoji: "ğŸ”´", hint: "Round like a ball!"},
      {name: "square", emoji: "ğŸŸ¨", hint: "Four equal sides!"},
      {name: "triangle", emoji: "ğŸ”º", hint: "Three sides!"},
      {name: "star", emoji: "â­", hint: "Shiny in the sky!"},
      {name: "heart", emoji: "â¤ï¸", hint: "Love shape!"},
      {name: "diamond", emoji: "ğŸ’", hint: "Sparkly gem!"}
    ]
  };
  
  let shapeList = shapes[level] || shapes[1];
  let questions = [];
  
  for(let i = 0; i < 5; i++) {
    let shape = shapeList[Math.floor(Math.random() * shapeList.length)];
    let wrongShapes = shapeList.filter(s => s.name !== shape.name).slice(0, 3);
    
    questions.push({
      type: 'shape',
      question: `What shape is this?`,
      shape: shape.name,
      display: shape.emoji,
      options: [shape.name, ...wrongShapes.map(s => s.name).slice(0, 2)],
      answer: shape.name,
      hint: shape.hint
    });
  }
  
  return questions;
}

// ========== PATTERNS ==========
function generatePatternQuestions(level) {
  const patterns = {
    1: [
      {pattern: ["ğŸ”´", "ğŸ”µ"], next: "ğŸ”´"},
      {pattern: ["ğŸŸ¡", "ğŸŸ¢"], next: "ğŸŸ¡"}
    ],
    2: [
      {pattern: ["ğŸ”´", "ğŸ”´", "ğŸ”µ"], next: "ğŸ”µ"},
      {pattern: ["ğŸŸ¡", "ğŸŸ¡", "ğŸŸ¢"], next: "ğŸŸ¢"}
    ],
    3: [
      {pattern: ["ğŸ¶", "ğŸ±", "ğŸ¶"], next: "ğŸ±"},
      {pattern: ["â­", "ğŸŒ™", "â­"], next: "ğŸŒ™"}
    ],
    4: [
      {pattern: ["ğŸ”´", "ğŸ”µ", "ğŸ”´", "ğŸ”µ"], next: "ğŸ”´"},
      {pattern: ["ğŸŸ¡", "ğŸŸ¢", "ğŸŸ¡", "ğŸŸ¢"], next: "ğŸŸ¡"}
    ],
    5: [
      {pattern: ["ğŸ¶", "ğŸ±", "ğŸ­", "ğŸ¶", "ğŸ±"], next: "ğŸ­"},
      {pattern: ["â­", "â­", "ğŸŒ™", "â­", "â­"], next: "ğŸŒ™"}
    ]
  };
  
  let patternList = patterns[level] || patterns[1];
  let questions = [];
  
  for(let i = 0; i < 5; i++) {
    let p = patternList[Math.floor(Math.random() * patternList.length)];
    let wrong1 = p.pattern[0];
    let wrong2 = p.pattern[1];
    
    questions.push({
      type: 'pattern',
      question: `What comes next?`,
      pattern: p.pattern,
      options: shuffle([p.next, wrong1, wrong2]),
      answer: p.next,
      hint: `Look at the pattern and say it out loud!`
    });
  }
  
  return questions;
}

// ============================================================
// STATE MANAGEMENT
// ============================================================
const PASS_PCT = 70; // Easier to pass for little ones
const STORAGE_KEY = "littleMath_v1";
const CATS = {
  counting: {label: "Counting", levels: 5, color: "#FF6B6B", icon: "ğŸ”¢"},
  numbers: {label: "Numbers", levels: 5, color: "#4ECDC4", icon: "123"},
  shapes: {label: "Shapes", levels: 5, color: "#FFD93D", icon: "ğŸ”´"},
  patterns: {label: "Patterns", levels: 5, color: "#96CEB4", icon: "ğŸ¨"}
};

let progress = {};
let cat = "", level = 0, questions = [], qi = 0, correct = 0, wrong = 0, mistakes = [];
let answered = false, hintCount = 0;

function initProgress() {
  Object.keys(CATS).forEach(c => {
    if(!progress[c]) progress[c] = {};
    for(let l = 1; l <= CATS[c].levels; l++) {
      if(!progress[c][l]) progress[c][l] = {done: false, stars: 0, unlocked: l === 1};
    }
  });
}

function saveProgress() {
  const blob = new Blob([JSON.stringify({v:1, progress}, null, 2)], {type: "application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "little-math-save.json";
  a.click();
  document.getElementById("saveLbl").textContent = "âœ… Saved! â­";
  setTimeout(updateSaveLbl, 2000);
}

function loadProgress() { 
  document.getElementById("loadFile").click(); 
}

function loadFile(e) {
  const file = e.target.files[0]; 
  if(!file) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      if(d.v === 1 && d.progress) {
        progress = d.progress;
        initProgress();
        updateSaveLbl();
      } else alert("Oops! Can't load that file.");
    } catch { alert("Hmm, that didn't work. Try again!"); }
  };
  r.readAsText(file);
  e.target.value = "";
}

function updateSaveLbl() {
  let totalStars = 0;
  Object.keys(CATS).forEach(c => {
    for(let l = 1; l <= CATS[c].levels; l++) {
      if(progress[c] && progress[c][l]) totalStars += progress[c][l].stars || 0;
    }
  });
  document.getElementById("saveLbl").textContent = "â­ " + totalStars + " stars";
  
  // Update progress chart
  let chart = document.getElementById("progressChart");
  if(chart) {
    let completed = 0, total = 0;
    Object.keys(CATS).forEach(c => {
      for(let l = 1; l <= CATS[c].levels; l++) {
        total++;
        if(progress[c] && progress[c][l] && progress[c][l].done) completed++;
      }
    });
    let pct = Math.round((completed/total)*100);
    
    chart.innerHTML = `
      <h3>ğŸ“Š My Math Journey</h3>
      <div style="margin-bottom:5px">â­ ${totalStars} stars earned!</div>
      <div class="progress-bar-cont"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
      <div class="progress-stats">
        <span>ğŸ”¢ ${progress.counting ? Object.values(progress.counting).filter(p => p.done).length : 0}/5</span>
        <span>123 ${progress.numbers ? Object.values(progress.numbers).filter(p => p.done).length : 0}/5</span>
        <span>ğŸ”´ ${progress.shapes ? Object.values(progress.shapes).filter(p => p.done).length : 0}/5</span>
        <span>ğŸ¨ ${progress.patterns ? Object.values(progress.patterns).filter(p => p.done).length : 0}/5</span>
      </div>
    `;
  }
}

function showScreen(id) {
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function showHome() { 
  updateSaveLbl();
  showScreen("homeScreen"); 
}

function openCategory(c) {
  cat = c;
  document.getElementById("levelsTitle").textContent = CATS[c].label + " â€” Choose Level";
  const grid = document.getElementById("levelsGrid");
  grid.innerHTML = "";
  const emojis = ["ğŸ¥‰", "ğŸ¥ˆ", "ğŸ¥‡", "ğŸ†", "ğŸ‘‘"];
  
  for(let l = 1; l <= CATS[c].levels; l++) {
    const p = progress[c][l];
    const btn = document.createElement("button");
    btn.className = "lv-btn" + (p.unlocked ? "" : " locked") + (p.done ? " done" : "");
    btn.innerHTML = '<span class="lv-icon">' + emojis[l-1] + '</span>Level ' + l + 
                    (p.stars > 0 ? '<div class="lv-score">â­ ' + p.stars + '</div>' : '') + 
                    (!p.unlocked ? '<span class="lv-lock">ğŸ”’</span>' : "");
    if(p.unlocked) btn.onclick = (function(ll) { return function() { startLevel(ll); }; })(l);
    grid.appendChild(btn);
  }
  showScreen("levelsScreen");
}

function startLevel(l) {
  level = l;
  qi = 0;
  correct = 0;
  wrong = 0;
  mistakes = [];
  answered = false;
  hintCount = 0;
  
  // Generate fresh problems!
  if(cat === 'counting') questions = generateCountingQuestions(level);
  else if(cat === 'numbers') questions = generateNumberQuestions(level);
  else if(cat === 'shapes') questions = generateShapeQuestions(level);
  else if(cat === 'patterns') questions = generatePatternQuestions(level);
  
  document.getElementById("quizLabel").textContent = CATS[cat].label + " â€¢ Level " + l;
  showScreen("quizScreen");
  loadQuestion();
}

function leaveQuiz() {
  if(confirm("Leave this game? You can come back anytime!")) showHome();
}

function loadQuestion() {
  answered = false;
  const q = questions[qi];
  const total = questions.length;
  
  document.getElementById("quizQNum").textContent = "Game " + (qi+1) + " / " + total;
  document.getElementById("qsCorrect").textContent = correct;
  document.getElementById("qsWrong").textContent = wrong;
  document.getElementById("qsAcc").textContent = "â­";
  document.getElementById("progFill").style.width = ((qi)/total*100) + "%";
  
  document.getElementById("feedback").className = "feedback";
  document.getElementById("explanation").className = "explanation";
  document.getElementById("hintBox").className = "hint-box";
  document.getElementById("checkBtn").style.display = "inline-flex";
  document.getElementById("nextBtn").style.display = "none";
  
  const hintAllowed = qi < 3 && hintCount < 3; // More hints for little ones
  const hintBtn = document.getElementById("hintBtn");
  hintBtn.style.display = hintAllowed ? "inline-flex" : "none";
  hintBtn.disabled = false;
  
  renderQuestion(q);
}

function renderQuestion(q) {
  const card = document.getElementById("qCard");
  const colors = {
    counting: "#FF6B6B",
    numbers: "#4ECDC4", 
    shapes: "#FFD93D",
    patterns: "#96CEB4"
  };
  card.style.borderTopColor = colors[cat];
  
  let html = `<div class="q-type-badge">${CATS[cat].icon} ${CATS[cat].label}</div>`;
  html += `<div class="q-text">${q.question}</div>`;
  
  if(cat === 'counting') {
    html += `<div class="object-row">`;
    q.objects.forEach(obj => {
      html += `<span class="count-object">${obj}</span>`;
    });
    html += `</div>`;
    
    // Big answer buttons for little fingers
    html += `<div class="big-answer-buttons" id="answerButtons">`;
    let answers = [q.answer, q.answer+1, q.answer-1].filter(n => n > 0 && n < 8);
    answers = [...new Set(answers)]; // Remove duplicates
    answers.sort(() => Math.random() - 0.5);
    answers.forEach(num => {
      html += `<button class="answer-btn" onclick="selectNumber(${num}, ${q.answer})">${num}</button>`;
    });
    html += `</div>`;
    
  } else if(cat === 'numbers') {
    html += `<div class="big-number">${q.number}</div>`;
    html += `<div class="big-answer-buttons" id="answerButtons">`;
    q.options.forEach(num => {
      html += `<button class="answer-btn" onclick="selectNumber(${num}, ${q.answer})">${num}</button>`;
    });
    html += `</div>`;
    
  } else if(cat === 'shapes') {
    html += `<div class="shape-display">`;
    if(q.shape === 'circle') html += `<div class="circle"></div>`;
    else if(q.shape === 'square') html += `<div class="square"></div>`;
    else if(q.shape === 'triangle') html += `<div class="triangle"></div>`;
    else if(q.shape === 'star') html += `<div class="star">â­</div>`;
    else if(q.shape === 'heart') html += `<div class="star">â¤ï¸</div>`;
    else if(q.shape === 'diamond') html += `<div class="star">ğŸ’</div>`;
    html += `</div>`;
    
    html += `<div class="options two-col" id="opts">`;
    q.options.forEach((opt, i) => {
      html += `<button class="opt-btn" onclick="selectOption(${i}, '${opt}', '${q.answer}')">${opt}</button>`;
    });
    html += `</div>`;
    
  } else if(cat === 'patterns') {
    html += `<div class="pattern-row">`;
    q.pattern.forEach(item => {
      html += `<span class="pattern-item">${item}</span>`;
    });
    html += `<span class="pattern-item missing">â“</span>`;
    html += `</div>`;
    
    html += `<div class="options two-col" id="opts">`;
    q.options.forEach((opt, i) => {
      html += `<button class="opt-btn" onclick="selectOption(${i}, '${opt}', '${q.answer}')">${opt}</button>`;
    });
    html += `</div>`;
  }
  
  card.innerHTML = html;
}

// Helper functions for answer selection
function selectNumber(num, correct) {
  if(answered) return;
  answered = true;
  
  const isCorrect = num === correct;
  
  if(isCorrect) { 
    correct++; 
    document.querySelectorAll('.answer-btn').forEach(btn => {
      if(btn.textContent == num) btn.classList.add('correct');
    });
  } else { 
    wrong++; 
    mistakes.push({q: "Count the objects", exp: "Try again! You'll get it next time!"});
    document.querySelectorAll('.answer-btn').forEach(btn => {
      if(btn.textContent == num) btn.classList.add('wrong');
      if(btn.textContent == correct) btn.classList.add('correct');
    });
  }
  
  showFeedback(isCorrect, isCorrect ? "ğŸ‰ Yay! Great counting!" : "ğŸ¤— Oops! Let's count together!");
}

function selectOption(idx, opt, correct) {
  if(answered) return;
  answered = true;
  
  const isCorrect = opt === correct;
  
  if(isCorrect) { 
    correct++; 
    document.querySelectorAll('.opt-btn')[idx].classList.add('correct');
  } else { 
    wrong++; 
    mistakes.push({q: "Find the right one", exp: "Good try! Let's learn together!"});
    document.querySelectorAll('.opt-btn')[idx].classList.add('wrong');
    // Highlight correct answer
    document.querySelectorAll('.opt-btn').forEach((btn, i) => {
      if(btn.textContent === correct) btn.classList.add('correct');
    });
  }
  
  showFeedback(isCorrect, isCorrect ? "ğŸŒŸ Perfect! You got it!" : "ğŸ’ª Almost! Try again next time!");
}

function checkAnswer() {
  // This is handled by the button clicks now
  if(!answered) {
    showFeedback(false, "ğŸ‘† Tap one of the big buttons!");
  }
}

function showFeedback(isCorrect, msg) {
  const fb = document.getElementById("feedback");
  fb.textContent = isCorrect ? "âœ… " + msg : "ğŸ’™ " + msg;
  fb.className = "feedback show " + (isCorrect ? "ok" : "bad");
  
  document.getElementById("checkBtn").style.display = "none";
  document.getElementById("nextBtn").style.display = "inline-flex";
  document.getElementById("hintBtn").style.display = "none";
  document.getElementById("qsCorrect").textContent = correct;
  document.getElementById("qsWrong").textContent = wrong;
}

function showHint() {
  const q = questions[qi];
  hintCount++;
  const hb = document.getElementById("hintBox");
  hb.textContent = "ğŸ’¡ " + (q.hint || "Count slowly with your finger!");
  hb.className = "hint-box show";
  document.getElementById("hintBtn").disabled = true;
}

function nextQuestion() {
  qi++;
  if(qi >= questions.length) showResult();
  else loadQuestion();
}

function showResult() {
  const total = questions.length;
  const pct = Math.round((correct/total)*100);
  const stars = Math.min(3, Math.ceil(correct / 2)); // 1-3 stars
  
  // Save progress
  if(correct >= 3) { // Pass if they got at least 3 right
    progress[cat][level].done = true;
    progress[cat][level].stars = Math.max(progress[cat][level].stars || 0, stars);
    if(level < CATS[cat].levels) progress[cat][level+1].unlocked = true;
  }
  
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify({v:1, progress})); } catch {}
  updateSaveLbl();
  
  // Celebration time!
  document.getElementById("resEmoji").textContent = stars === 3 ? "ğŸ†" : stars === 2 ? "ğŸŒŸ" : "â­";
  document.getElementById("resTitle").textContent = stars === 3 ? "SUPERSTAR!" : stars === 2 ? "Great Job!" : "Good Try!";
  document.getElementById("resPct").innerHTML = "â­".repeat(stars);
  document.getElementById("resStars").innerHTML = "â­".repeat(stars);
  document.getElementById("resMsg").innerHTML = stars === 3 ? "You got all stars! Amazing!" 
    : stars === 2 ? "You did great! Want to try for 3 stars?" 
    : "Good job! Every star counts! â­";
  
  const ms = document.getElementById("mistakeSection");
  if(mistakes.length > 0) {
    ms.innerHTML = '<div class="mistake-title">ğŸ’ª Let\'s practice more:</div>' + 
      mistakes.map(() => '<div class="mistake-item">Keep trying! You\'ll get it! ğŸŒŸ</div>').join("");
  } else ms.innerHTML = "";
  
  document.getElementById("retryBtn").onclick = function() { startLevel(level); };
  const nb = document.getElementById("nextLvBtn");
  if(correct >= 3 && level < CATS[cat].levels) {
    nb.style.display = "inline-flex";
    nb.onclick = function() { startLevel(level + 1); };
  } else nb.style.display = "none";
  
  showScreen("resultScreen");
}

// Initialize
(function init() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) { const d = JSON.parse(raw); if(d.v === 1 && d.progress) progress = d.progress; }
  } catch {}
  initProgress();
  updateSaveLbl();
})();
</script>
</body>
</html>
